echo "ðŸ” Running pre-commit checks..."

# Run type checking first (fast fail)
echo "ðŸ“ Type checking..."
pnpm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type check failed. Please fix TypeScript errors before committing."
  exit 1
fi

# Run lint-staged for file-specific checks
echo "ðŸ§¹ Running lint-staged..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed. Please fix linting errors before committing."
  exit 1
fi

# Run tests to ensure nothing is broken
echo "ðŸ§ª Running tests..."
pnpm run test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix failing tests before committing."
  exit 1
fi

# Check for security issues in dependencies
echo "ðŸ”’ Checking for security vulnerabilities..."
if ! pnpm audit --audit-level moderate; then
  echo "âš ï¸  Security vulnerabilities found. Consider running 'pnpm audit fix' or review the issues."
  if [ -n "$CI" ] || [ "$HUSKY_AUDIT_AUTO_APPROVE" = "1" ]; then
    echo "ðŸ¤– Non-interactive mode detected. Continuing despite audit warnings."
  else
    echo "ðŸ¤” Do you want to continue? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
      echo "âŒ Commit aborted due to security concerns."
      exit 1
    fi
  fi
fi

# Check for TODO/FIXME comments in staged files
echo "ðŸ“‹ Checking for TODO/FIXME comments..."
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js)$')
if [ -n "$staged_files" ]; then
  todo_count=$(echo "$staged_files" | xargs grep -l "TODO\|FIXME" 2>/dev/null | wc -l)
  if [ "$todo_count" -gt 0 ]; then
    echo "âš ï¸  Found TODO/FIXME comments in staged files:"
    echo "$staged_files" | xargs grep -n "TODO\|FIXME" 2>/dev/null || true
    echo "ðŸ’¡ Consider addressing these before committing."
  fi
fi

echo "âœ… All pre-commit checks passed!"

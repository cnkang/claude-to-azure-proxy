echo "ğŸš€ Running pre-push checks..."

# Get the current branch
current_branch=$(git symbolic-ref --short HEAD)

# Skip checks for main branch (assuming it's protected)
if [ "$current_branch" = "main" ]; then
  echo "ğŸ“‹ Skipping pre-push checks for main branch"
  exit 0
fi

# Run comprehensive tests with coverage
echo "ğŸ§ª Running comprehensive test suite..."
NODE_OPTIONS='--max-old-space-size=16384 --expose-gc' pnpm run test:coverage
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix failing tests before pushing."
  exit 1
fi

# Run security audit
echo "ğŸ”’ Running security audit..."
pnpm audit --audit-level high
if [ $? -ne 0 ]; then
  echo "âŒ High severity security vulnerabilities found. Please fix before pushing."
  exit 1
fi

# Check if build succeeds
echo "ğŸ—ï¸  Testing build process..."
pnpm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Please fix build errors before pushing."
  exit 1
fi

# Clean up build artifacts
rm -rf dist/

# Check for large files
echo "ğŸ“ Checking for large files..."
large_files=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9 " (" $5 " bytes)"}')
if [ -n "$large_files" ]; then
  echo "âš ï¸  Large files detected (>1MB):"
  echo "$large_files"
  echo "ğŸ¤” Consider using Git LFS for large files. Continue? (y/N)"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    echo "âŒ Push aborted due to large files."
    exit 1
  fi
fi

echo "âœ… All pre-push checks passed!"